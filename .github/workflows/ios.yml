name: iOS CI/CD

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ° main åˆ†æ”¯å’Œåˆ›å»º Pull Request æ—¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  test:
    name: Test iOS Project
    runs-on: macos-14  # ä½¿ç”¨æœ€æ–°çš„ macOS runnerï¼Œæ”¯æŒ Xcode 15+
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'  # æŒ‡å®š Xcode ç‰ˆæœ¬
        
    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.cache/swift-package-manager
        key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.swift', '**/*.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-
          
    - name: Check Swift Version
      run: swift --version
      
    - name: List Available Simulators
      run: xcrun simctl list devices available iOS
      
    - name: Run Swift Tests
      run: |
        # ä½¿ç”¨ swift test è¿è¡Œ Swift Package Manager æµ‹è¯•
        if [ -f "Package.swift" ]; then
          swift test
        fi
        
    - name: Build for iOS Simulator
      run: |
        # æŸ¥æ‰¾ .xcodeproj æ–‡ä»¶
        XCODE_PROJECT=$(find . -name "*.xcodeproj" -type d | head -1)
        if [ -n "$XCODE_PROJECT" ]; then
          PROJECT_NAME=$(basename "$XCODE_PROJECT" .xcodeproj)
          echo "Building project: $PROJECT_NAME"
          
          # æž„å»º iOS æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬
          xcodebuild \
            -project "$XCODE_PROJECT" \
            -scheme "$PROJECT_NAME" \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -configuration Debug \
            build
        else
          echo "No Xcode project found"
        fi
        
    - name: Run Unit Tests
      run: |
        XCODE_PROJECT=$(find . -name "*.xcodeproj" -type d | head -1)
        if [ -n "$XCODE_PROJECT" ]; then
          PROJECT_NAME=$(basename "$XCODE_PROJECT" .xcodeproj)
          echo "Running tests for project: $PROJECT_NAME"
          
          # è¿è¡Œå•å…ƒæµ‹è¯•
          xcodebuild \
            -project "$XCODE_PROJECT" \
            -scheme "$PROJECT_NAME" \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -configuration Debug \
            test
        else
          echo "No Xcode project found"
        fi
        
    - name: Generate Test Report
      if: always()
      run: |
        echo "## Test Results ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "Build and test completed for iOS project" >> $GITHUB_STEP_SUMMARY
        
  build-macos:
    name: Build macOS Project
    runs-on: macos-14
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: Build for macOS
      run: |
        XCODE_PROJECT=$(find . -name "*.xcodeproj" -type d | head -1)
        if [ -n "$XCODE_PROJECT" ]; then
          PROJECT_NAME=$(basename "$XCODE_PROJECT" .xcodeproj)
          echo "Building macOS version of project: $PROJECT_NAME"
          
          # æž„å»º macOS ç‰ˆæœ¬
          xcodebuild \
            -project "$XCODE_PROJECT" \
            -scheme "$PROJECT_NAME" \
            -destination 'platform=macOS' \
            -configuration Debug \
            build
        else
          echo "No Xcode project found"
        fi

  code-quality:
    name: Code Quality Check
    runs-on: macos-14
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: SwiftLint Check
      run: |
        # å¦‚æžœé¡¹ç›®ä¸­æœ‰ SwiftLint é…ç½®ï¼Œè¿è¡Œ SwiftLint
        if command -v swiftlint &> /dev/null; then
          swiftlint --strict
        else
          echo "SwiftLint not installed, skipping..."
        fi
        
    - name: Swift Format Check
      run: |
        # æ£€æŸ¥ Swift ä»£ç æ ¼å¼
        if command -v swift-format &> /dev/null; then
          swift-format lint --recursive .
        else
          echo "swift-format not installed, skipping..."
        fi
